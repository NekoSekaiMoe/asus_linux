name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  build-deb-amd64:
    container: debian:trixie
    runs-on: ubuntu-latest
    steps:
      - name: Install Build Tools
        run: |
          echo "deb-src http://deb.debian.org/debian/ trixie main contrib non-free" | tee -a /etc/apt/sources.list >/dev/null
          apt update && apt install -y debhelper dpkg-dev build-essential patch bc bison flex libssl-dev libelf-dev git perl python3
                  

      - name: Checkout linux
        uses: actions/checkout@v4
        with:
          repository: torvalds/linux
          ref: v6.9
          fetch-depth: 1

      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Ccache for gh actions
        uses: hendrikmuhs/ccache-action@v1.2.13
        with:
          key: ee2b31d23ae6068c6aecc2e81e4b71c40ed72654
            
      - name: patch
        run: |
          set -x
          git clone https://salsa.debian.org/kernel-team/linux/ deb --depth=1
          git apply deb/debian/patches/bugfix/x86/*.patch
          git apply deb/debian/patches/bugfix/all/*.patch
          git apply deb/debian/patches/debian/*.patch
          git apply deb/debian/patches/debian/dfsg/*.patch
          git apply deb/debian/patches/features/x86/*.patch
          git apply deb/debian/patches/features/all/*.patch
          git apply deb/debian/patches/features/all/lockdown/*.patch
          git apply deb/debian/patches/features/all/db-mok-keyring/*.patch
          git apply ./patches/*.patch
          mv ./asus_defconfig ./arch/x86/configs/

      - name: Configure
        run: |
          make asus_defconfig
          bash ./patch.sh

      - name: build
        env:
          CC: "ccache gcc"
        run: |
          export USE_CCACHE=1
          make -j8 
          
      - name: Package
        env:
          CC: "ccache gcc"
        run: |
          export USE_CCACHE=1
          make -j8 deb-pkg V=1
      - name: Commit updates
        run: |
          git config user.name "dabao1955"
          git config user.email "dabao1955@163.com"
          make mrproper
          git add .
          git commit -m "add g14 changes"
